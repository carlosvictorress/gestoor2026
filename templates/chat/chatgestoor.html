<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Atendimento ao Cidadão</title>
    <script src="https://cdn.tailwindcss.com"></script> 
</head>
<body class="bg-[#e5ddd5] flex flex-col h-screen overflow-hidden">

    <header class="bg-[#075e54] p-4 flex items-center shadow-md shrink-0">
        <div class="flex items-center gap-3">
            <div class="w-10 h-10 rounded-full bg-white flex items-center justify-center">
                <span class="text-[#075e54] font-bold">G</span> </div>
            <div>
                <h1 class="text-white font-semibold">Atendimento ao Cidadão</h1>
                <p class="text-[10px] text-green-300">Responde em instantes</p>
            </div>
        </div>
    </header>

    <main id="chat-window" class="flex-1 overflow-y-auto p-4 space-y-4">
        <div class="flex justify-start">
            <div class="bg-white p-3 rounded-lg rounded-tl-none shadow-sm max-w-[80%]">
                <p class="text-sm text-gray-800">Bom dia, em que posso ajudá-lo?</p>
                <span class="text-[10px] text-gray-500 block text-right">08:30</span>
            </div>
        </div>

        <div class="flex justify-end">
            <div class="bg-[#dcf8c6] p-3 rounded-lg rounded-tr-none shadow-sm max-w-[80%]">
                <p class="text-sm text-gray-800">Quero saber que horas o ônibus escolar passa na rua tal?</p>
                <span class="text-[10px] text-gray-500 block text-right">08:31</span>
            </div>
        </div>

    </main>

    <footer class="bg-[#f0f0f0] p-3 pb-6 flex items-center gap-2 border-t shrink-0">
        <input type="text" id="user-input" placeholder="Digite sua dúvida..." 
               class="flex-1 p-3 rounded-2xl border-none shadow-sm focus:ring-0 text-sm">
        <button onclick="sendMessage()" class="bg-[#075e54] text-white p-3 rounded-full shadow-lg active:scale-95 transition-transform">
            <svg class="h-6 w-6 transform rotate-45" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8" />
            </svg>
        </button>
    </footer>

    <script>
        const chatWindow = document.getElementById('chat-window');
        const userInput = document.getElementById('user-input');

        function scrollToBottom() {
            chatWindow.scrollTop = chatWindow.scrollHeight;
        }

        // Função para adicionar uma mensagem à janela de chat
        function addMessage(text, isUser = true) {
            const messageDiv = document.createElement('div');
            messageDiv.className = isUser ? 'flex justify-end' : 'flex justify-start';
            
            const bubbleDiv = document.createElement('div');
            bubbleDiv.className = `p-3 rounded-lg shadow-sm max-w-[80%] ${isUser ? 'bg-[#dcf8c6] rounded-tr-none' : 'bg-white rounded-tl-none'}`;
            
            const messageText = document.createElement('p');
            messageText.className = 'text-sm text-gray-800';
            messageText.textContent = text;
            
            const timestamp = document.createElement('span');
            timestamp.className = 'text-[10px] text-gray-500 block text-right';
            timestamp.textContent = new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });

            bubbleDiv.appendChild(messageText);
            bubbleDiv.appendChild(timestamp);
            messageDiv.appendChild(bubbleDiv);
            chatWindow.appendChild(messageDiv);
            scrollToBottom();
        }

        // Função para enviar a mensagem (será integrada com o Flask depois)
       async function sendMessage() {
    const message = userInput.value.trim();
    if (message === "") return; // Não envia mensagens vazias

    // 1. Adiciona a mensagem do cidadão na tela imediatamente
    addMessage(message, true); 
    userInput.value = ''; // Limpa o campo de texto

    try {
        // 2. Envia a mensagem para o seu Blueprint no Flask
        // Note o caminho '/atendimento/ask' que definimos no whatsapp_bp
        const response = await fetch('/atendimento/ask', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ message: message })
        });

        if (!response.ok) throw new Error('Erro na rede');

        const data = await response.json();

        // 3. Adiciona a resposta real do seu Agente Virtual (vindo do Flask)
        setTimeout(() => {
            addMessage(data.response, false);
        }, 600); // Um pequeno delay para parecer que o agente está digitando

    } catch (error) {
        console.error("Erro ao conectar:", error);
        addMessage("Desculpe, estou com problemas de conexão. Tente novamente em instantes.", false);
    }
}

        // Garante que o chat esteja no final ao carregar a página
        window.onload = scrollToBottom;
    </script>
</body>
</html>