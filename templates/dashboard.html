{% extends 'base.html' %}

{% block title %}Dashboard | Sistema de Gestão{% endblock %}

{% block content %}
<style>
    /* Estilização Profissional */
    :root {
        --glass-bg: rgba(255, 255, 255, 0.9);
        --primary-gradient: linear-gradient(135deg, #0d6efd 0%, #0a58ca 100%);
    }

    body { background-color: #f4f7f6; }

    .page-header { margin-bottom: 2rem; }
    
    .card { 
        border: none; 
        border-radius: 15px; 
        box-shadow: 0 4px 12px rgba(0,0,0,0.05); 
        transition: transform 0.2s ease;
    }
    
    .card:hover { transform: translateY(-5px); }

    /* Estilo dos Cards de KPI */
    .stat-card { position: relative; overflow: hidden; color: white; border-radius: 15px; }
    .stat-card .card-body { position: relative; z-index: 1; }
    .stat-icon-bg {
        position: absolute;
        right: -10px;
        bottom: -10px;
        font-size: 5rem;
        opacity: 0.15;
        transform: rotate(-15deg);
    }

    /* Cores Customizadas */
    .bg-gradient-primary { background: var(--primary-gradient); }
    .bg-gradient-success { background: linear-gradient(135deg, #198754 0%, #146c43 100%); }
    .bg-gradient-info { background: linear-gradient(135deg, #0dcaf0 0%, #0bacce 100%); }
    .bg-gradient-warning { background: linear-gradient(135deg, #ffc107 0%, #e0a800 100%); }

    /* Filtros */
    .filter-section {
        background: white;
        padding: 1.5rem;
        border-radius: 15px;
        margin-bottom: 2rem;
        border: 1px solid #edf2f9;
    }

    .chart-container { padding: 1.5rem; }
    .card-title-main { font-weight: 700; color: #2d3748; font-size: 1.1rem; }
</style>

<div class="container-fluid py-4">
    <div class="page-header d-md-flex justify-content-between align-items-center">
        <div>
            <h2 class="fw-bold text-dark mb-0"><i class="bi bi-grid-1x2-fill me-2 text-primary"></i>Dashboard Geral</h2>
            <nav aria-label="breadcrumb">
                <ol class="breadcrumb mb-0">
                    <li class="breadcrumb-item">Sistema</li>
                    <li class="breadcrumb-item active" aria-current="page">Visão Geral</li>
                </ol>
            </nav>
        </div>
        <div class="mt-3 mt-md-0">
            <span class="badge bg-white text-dark border p-2 shadow-sm">
                {% if session.get('role') == 'admin' %}
                    <i class="bi bi-shield-check text-primary me-1"></i> 
                    Admin: <strong>{{ secretaria_selecionada.nome if secretaria_selecionada else 'Todas as Secretarias' }}</strong>
                {% else %}
                    <i class="bi bi-building text-secondary me-1"></i> 
                    Secretaria: <strong>{{ session.get('secretaria') }}</strong>
                {% endif %}
            </span>
        </div>
    </div>

    {% if session.get('role') == 'admin' %}
    <div class="filter-section shadow-sm">
        <form method="GET" action="{{ url_for('dashboard') }}" class="row g-3 align-items-end">
            <div class="col-md-5">
                <label for="secretaria_id" class="form-label small fw-bold text-muted text-uppercase">Filtrar Secretaria</label>
                <select name="secretaria_id" id="secretaria_id" class="form-select border-0 bg-light">
                    <option value="">-- Todas as Secretarias --</option>
                    {% for sec in secretarias %}
                    <option value="{{ sec.id }}" {% if secretaria_selecionada and secretaria_selecionada.id == sec.id %}selected{% endif %}>
                        {{ sec.nome }}
                    </option>
                    {% endfor %}
                </select>
            </div>
            <div class="col-md-3">
                <button type="submit" class="btn btn-primary w-100 fw-bold">
                    <i class="bi bi-funnel me-2"></i>Aplicar Filtro
                </button>
            </div>
            <div class="col-md-2">
                <a href="{{ url_for('dashboard') }}" class="btn btn-outline-secondary w-100">
                    <i class="bi bi-arrow-clockwise"></i> Limpar
                </a>
            </div>
        </form>
    </div>
    {% endif %}

    <div class="row g-4 mb-4">
        <div class="col-lg-3 col-md-6">
            <div class="card stat-card bg-gradient-primary h-100">
                <div class="card-body">
                    <h6 class="text-uppercase mb-2 opacity-75">Total Servidores</h6>
                    <h2 class="display-6 fw-bold mb-0">{{ total_servidores }}</h2>
                    <i class="bi bi-people-fill stat-icon-bg"></i>
                </div>
            </div>
        </div>
        <div class="col-lg-3 col-md-6">
            <div class="card stat-card bg-gradient-success h-100">
                <div class="card-body">
                    <h6 class="text-uppercase mb-2 opacity-75">Média Salarial</h6>
                    <h2 class="display-6 fw-bold mb-0">R$ {{ '%.2f'|format(remuneracao_media)|replace('.', ',') if remuneracao_media else '0,00' }}</h2>
                    <i class="bi bi-cash-coin stat-icon-bg"></i>
                </div>
            </div>
        </div>
        <div class="col-lg-3 col-md-6">
            <div class="card stat-card bg-gradient-info h-100">
                <div class="card-body">
                    <h6 class="text-uppercase mb-2 opacity-75">Cargos/Funções</h6>
                    <h2 class="display-6 fw-bold mb-0">{{ funcao_labels|length }}</h2>
                    <i class="bi bi-briefcase-fill stat-icon-bg"></i>
                </div>
            </div>
        </div>
        <div class="col-lg-3 col-md-6">
            <div class="card stat-card bg-gradient-warning h-100 text-dark">
                <div class="card-body">
                    <h6 class="text-uppercase mb-2 opacity-75">Combustível (Ano)</h6>
                    <h2 class="display-6 fw-bold mb-0">{{ "%.0f"|format(total_litros_ano) }} <small class="fs-4">L</small></h2>
                    <i class="bi bi-fuel-pump-fill stat-icon-bg"></i>
                </div>
            </div>
        </div>
    </div>

    <div class="row g-4">
        <div class="col-12">
            <div class="card shadow-sm">
                <div class="card-header bg-white py-3 border-0">
                    <h5 class="card-title-main mb-0"><i class="bi bi-bar-chart-line text-warning me-2"></i>Consumo Mensal de Combustível ({{ ano_atual }})</h5>
                </div>
                <div class="card-body pt-0">
                    <div style="height: 300px;">
                        <canvas id="combustivelChart"></canvas>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-lg-6">
            <div class="card shadow-sm h-100">
                <div class="card-header bg-white py-3 border-0">
                    <h5 class="card-title-main mb-0"><i class="bi bi-pie-chart text-primary me-2"></i>Distribuição por Função</h5>
                </div>
                <div class="card-body pt-0">
                    <canvas id="funcaoChart"></canvas>
                </div>
            </div>
        </div>

        <div class="col-lg-6">
            <div class="card shadow-sm h-100">
                <div class="card-header bg-white py-3 border-0">
                    <h5 class="card-title-main mb-0"><i class="bi bi-align-start text-success me-2"></i>Top Lotações (Servidores)</h5>
                </div>
                <div class="card-body pt-0">
                    <canvas id="lotacaoChart"></canvas>
                </div>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Configurações Globais
    Chart.defaults.font.family = "'Segoe UI', 'Roboto', sans-serif";
    Chart.defaults.color = '#718096';

    const ctxCombustivel = document.getElementById('combustivelChart');
    if (ctxCombustivel) {
        new Chart(ctxCombustivel, {
            type: 'bar',
            data: {
                labels: {{ combustivel_labels|tojson }},
                datasets: [{
                    label: 'Litros',
                    data: {{ combustivel_data|tojson }},
                    backgroundColor: '#ffc107',
                    borderRadius: 8,
                    maxBarThickness: 40
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: { legend: { display: false } },
                scales: { 
                    y: { beginAtZero: true, grid: { borderDash: [5, 5] } },
                    x: { grid: { display: false } }
                }
            }
        });
    }

    const ctxFuncao = document.getElementById('funcaoChart');
    if (ctxFuncao) {
        new Chart(ctxFuncao, {
            type: 'doughnut',
            data: {
                labels: {{ funcao_labels|tojson }},
                datasets: [{
                    data: {{ funcao_data|tojson }},
                    backgroundColor: ['#4e73df', '#1cc88a', '#36b9cc', '#f6c23e', '#e74a3b', '#858796'],
                    hoverOffset: 15,
                    borderWidth: 0
                }]
            },
            options: {
                plugins: { legend: { position: 'bottom', labels: { padding: 20, usePointStyle: true } } },
                cutout: '70%'
            }
        });
    }

    const ctxLotacao = document.getElementById('lotacaoChart');
    if (ctxLotacao) {
        new Chart(ctxLotacao, {
            type: 'bar',
            data: {
                labels: {{ lotacao_labels|tojson }},
                datasets: [{
                    label: 'Servidores',
                    data: {{ lotacao_data|tojson }},
                    backgroundColor: '#198754',
                    borderRadius: 5
                }]
            },
            options: {
                indexAxis: 'y',
                responsive: true,
                plugins: { legend: { display: false } },
                scales: { x: { grid: { display: false } } }
            }
        });
    }
});
</script>
{% endblock %}