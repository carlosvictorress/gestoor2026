{% extends 'base.html' %}

{% block title %}Dashboard | Gestão de Merenda{% endblock %}

{% block content %}
<style>
    :root {
        --primary-soft: #f0f4f8;
        --sidebar-bg: #212529;
    }
    .card { border: none; border-radius: 12px; transition: transform 0.2s; }
    .card:hover { transform: translateY(-3px); }
    .kpi-icon {
        width: 48px; height: 48px; border-radius: 10px;
        display: flex; align-items: center; justify-content: center; font-size: 1.5rem;
    }
    .nav-pills .nav-link { color: #6c757d; font-weight: 500; }
    .nav-pills .nav-link.active { background-color: #0d6efd; }
    .table thead th { 
        text-transform: uppercase; font-size: 0.75rem; letter-spacing: 0.05em; 
        background-color: var(--primary-soft); border: none;
    }
    .status-badge { padding: 0.5em 1em; border-radius: 50px; font-size: 0.75rem; }
    .border-top-warning { border-top: 5px solid #ffc107 !important; }
</style>

<div class="container-fluid py-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h2 class="fw-bold mb-0">Painel de Controle</h2>
            <p class="text-muted">Gestão integrada da Merenda Escolar</p>
        </div>
        <div class="d-flex gap-2">
            <button type="button" class="btn btn-warning fw-bold text-white shadow-sm px-4" data-bs-toggle="modal" data-bs-target="#modalSolicitarEmpresa">
                <i class="bi bi-cart-plus-fill me-2"></i>SOLICITAR À EMPRESA
            </button>
            <a href="{{ url_for('merenda.agricultura_dashboard') }}" class="btn btn-success px-4 shadow-sm">
                <i class="bi bi-tree me-2"></i>Agricultura Familiar
            </a>
        </div>
    </div>

    <ul class="nav nav-pills mb-4 bg-white p-2 rounded shadow-sm">
        <li class="nav-item"><a class="nav-link active" href="#"><i class="bi bi-speedometer2 me-2"></i>Geral</a></li>
        <li class="nav-item"><a class="nav-link" href="{{ url_for('merenda.painel_solicitacoes') }}"><i class="bi bi-clipboard-check me-2"></i>Solicitações</a></li>
        <li class="nav-item"><a class="nav-link" href="{{ url_for('merenda.gerenciar_cardapio') }}"><i class="bi bi-calendar-week me-2"></i>Cardápios</a></li>
        <li class="nav-item"><a class="nav-link" href="{{ url_for('merenda.listar_escolas') }}"><i class="bi bi-building me-2"></i>Escolas</a></li>
        <li class="nav-item"><a class="nav-link" href="{{ url_for('merenda.listar_produtos') }}"><i class="bi bi-box-seam me-2"></i>Produtos</a></li>
        <li class="nav-item dropdown">
            <a class="nav-link dropdown-toggle" data-bs-toggle="dropdown" href="#"><i class="bi bi-file-earmark-bar-graph me-2"></i>Relatórios</a>
            <ul class="dropdown-menu">
                <li><a class="dropdown-item" href="{{ url_for('merenda.relatorios_tecnicos') }}">Técnicos e Ofícios</a></li>
                <li><hr class="dropdown-divider"></li>
                <li><a class="dropdown-item" href="{{ url_for('merenda.relatorio_saidas') }}">Saídas de Estoque</a></li>
                <li><a class="dropdown-item" href="{{ url_for('merenda.relatorio_consolidado_mensal') }}">Consumo Mensal</a></li>
            </ul>
        </li>
    </ul>

    <div class="row g-3 mb-4">
        <div class="col-md-4">
            <div class="card shadow-sm"><div class="card-body d-flex align-items-center">
                <div class="kpi-icon bg-primary text-white me-3"><i class="bi bi-building"></i></div>
                <div><h6 class="text-muted mb-0">Escolas Ativas</h6><span class="h3 fw-bold">{{ total_escolas_ativas }}</span></div>
            </div></div>
        </div>
        <div class="col-md-4">
            <div class="card shadow-sm"><div class="card-body d-flex align-items-center">
                <div class="kpi-icon bg-success text-white me-3"><i class="bi bi-box-seam"></i></div>
                <div><h6 class="text-muted mb-0">Produtos no Catálogo</h6><span class="h3 fw-bold">{{ total_produtos }}</span></div>
            </div></div>
        </div>
        <div class="col-md-4">
            <div class="card shadow-sm"><div class="card-body d-flex align-items-center">
                <div class="kpi-icon bg-warning text-dark me-3"><i class="bi bi-hourglass-split"></i></div>
                <div><h6 class="text-muted mb-0">Pendentes de Aprovação</h6><span class="h3 fw-bold">{{ solicitacoes_pendentes }}</span></div>
            </div></div>
        </div>
    </div>

    <div class="row mb-4 g-4">
        <div class="col-lg-7">
            <div class="card shadow-sm h-100">
                <div class="card-header bg-white py-3"><h6 class="m-0 fw-bold text-primary">Consumo por Unidade Escolar</h6></div>
                <div class="card-body"><canvas id="topEscolasChart" style="min-height: 300px;"></canvas></div>
            </div>
        </div>
        <div class="col-lg-5">
            <div class="card shadow-sm h-100">
                <div class="card-header bg-white py-3"><h6 class="m-0 fw-bold text-primary">Distribuição de Demanda</h6></div>
                <div class="card-body"><canvas id="topProdutosChart" style="min-height: 300px;"></canvas></div>
            </div>
        </div>
    </div>

    <div class="row g-4">
        <div class="col-xl-8">
            <div class="card shadow-sm">
                <div class="card-header bg-white py-3"><h6 class="m-0 fw-bold text-danger"><i class="bi bi-calendar-x me-2"></i>Controle de Validade (45 dias)</h6></div>
                <div class="card-body p-0">
                    <div class="table-responsive">
                        <table class="table table-hover mb-0">
                            <thead><tr><th class="ps-4">Produto / Lote</th><th class="text-center">Vencimento</th><th class="text-center">Status</th><th class="text-center pe-4">Saldo</th></tr></thead>
                            <tbody>
                                {% for item in alertas_validade %}
                                {% set dias_restantes = (item.data_validade - hoje).days %}
                                <tr>
                                    <td class="ps-4"><div class="fw-bold">{{ item.nome }}</div><small class="text-muted">Lote: {{ item.lote or 'N/A' }}</small></td>
                                    <td class="text-center fw-bold">{{ item.data_validade.strftime('%d/%m/%Y') }}</td>
                                    <td class="text-center">
                                        <span class="badge status-badge {{ 'bg-danger' if dias_restantes < 0 else 'bg-warning text-dark' if dias_restantes <= 15 else 'bg-info text-dark' }}">
                                            {{ 'Expirado' if dias_restantes < 0 else 'Crítico' if dias_restantes <= 15 else 'Atenção' }}
                                        </span>
                                    </td>
                                    <td class="text-center pe-4 font-monospace">{{ item.estoque_atual }} {{ item.unidade_medida }}</td>
                                </tr>
                                {% else %}
                                <tr><td colspan="4" class="text-center py-5 text-muted">Nenhum alerta detectado.</td></tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-xl-4">
            <div class="card shadow-sm border-start border-danger border-4">
                <div class="card-header bg-white py-3"><h6 class="m-0 fw-bold text-danger"><i class="bi bi-exclamation-circle me-2"></i>Estoque Crítico</h6></div>
                <div class="card-body">
                    {% for p in produtos_estoque_baixo %}
                    <div class="d-flex justify-content-between align-items-center mb-3 pb-2 border-bottom">
                        <div><div class="fw-bold">{{ p.nome }}</div><small class="text-danger">Apenas {{ p.estoque_atual }} {{ p.unidade_medida }}</small></div>
                        <a href="{{ url_for('merenda.entrada_estoque') }}" class="btn btn-sm btn-light border"><i class="bi bi-plus-lg"></i></a>
                    </div>
                    {% else %}
                    <div class="text-center py-3 text-success"><i class="bi bi-check-all fs-2"></i><p class="mb-0">Estoque regularizado</p></div>
                    {% endfor %}
                </div>
            </div>
        </div>

        <div class="col-12 mt-4">
            <div class="card shadow-sm border-top-warning">
                <div class="card-header bg-white py-3 d-flex justify-content-between align-items-center">
                    <h6 class="m-0 fw-bold"><i class="bi bi-list-check me-2 text-warning"></i>Histórico de Solicitações à Empresa</h6>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-hover align-middle">
                            <thead class="table-light">
                                <tr><th>Código</th><th>Data</th><th>Solicitante</th><th>Status</th><th class="text-center">Ações</th></tr>
                            </thead>
                            <tbody>
                                {% for pedido in pedidos_empresa %}
                               <tr>
    <td>#{{ pedido.id }}</td>
    <td>{{ pedido.data_pedido.strftime('%d/%m/%Y %H:%M') }}</td>
    <td>{{ pedido.solicitante }}</td>
    <td>
        <span class="badge {{ 'bg-info' if pedido.status == 'Rascunho' else 'bg-success' }}">
            {{ pedido.status }}
        </span>
    </td>
    <td class="text-center">
        <div class="btn-group shadow-sm">
            <a href="{{ url_for('merenda.gerar_pdf_pedido', id=pedido.id) }}" class="btn btn-sm btn-outline-danger" title="Gerar PDF">
                <i class="bi bi-file-pdf"></i>
            </a>

            {% if pedido.status == 'Rascunho' %}
                <a href="{{ url_for('merenda.editar_pedido_empresa', id=pedido.id) }}" class="btn btn-sm btn-outline-primary" title="Editar Rascunho">
                    <i class="bi bi-pencil"></i>
                </a>

                <a href="{{ url_for('merenda.enviar_pedido_fornecedor', id=pedido.id) }}" class="btn btn-sm btn-outline-success" title="Enviar" onclick="return confirm('Bloquear alterações e enviar?')">
                    <i class="bi bi-send-check"></i>
                </a>

                <a href="{{ url_for('merenda.excluir_pedido_empresa', id=pedido.id) }}" class="btn btn-sm btn-outline-secondary" title="Excluir" onclick="return confirm('Excluir rascunho?')">
                    <i class="bi bi-trash"></i>
                </a>
            {% endif %}
        </div>
    </td>
</tr>
                                {% else %}
                                <tr><td colspan="5" class="text-center py-4">Nenhuma solicitação este mês.</td></tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="modalSolicitarEmpresa" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <form action="{{ url_for('merenda.novo_pedido_empresa') }}" method="POST">
            <div class="modal-content border-0 shadow-lg">
                <div class="modal-header bg-warning text-white py-3">
                    <h5 class="modal-title fw-bold"><i class="bi bi-cart-plus-fill me-2"></i>Nova Solicitação de Produtos</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body p-4">
                    <div class="table-responsive" style="max-height: 450px;">
                        <table class="table table-hover align-middle">
                            <thead class="sticky-top bg-white border-bottom">
                                <tr><th>Produto</th><th>Unidade</th><th width="180">Quantidade</th></tr>
                            </thead>
                            <tbody>
                                {% for produto in produtos_disponiveis %}
                                <tr>
                                    <td class="fw-bold">
                                        {{ produto.nome }}
                                        {% if produto.fator_conversao and produto.fator_conversao > 1 %}
                                            <br><small class="text-primary">(1 {{ produto.unidade_medida }} = {{ produto.fator_conversao|int }} un/kg)</small>
                                        {% endif %}
                                    </td>
                                    <td><span class="badge bg-light text-dark">{{ produto.unidade_medida }}</span></td>
                                    <td>
                                        <input type="hidden" name="produto_id[]" value="{{ produto.id }}">
                                        <div class="input-group mb-1">
                                            <input type="number" step="0.01" min="0" name="quantidade[]" 
                                                   class="form-control input-qtd" 
                                                   placeholder="Qtd"
                                                   data-fator="{{ produto.fator_conversao or 1.0 }}">
                                            <span class="input-group-text">{{ produto.unidade_medida|lower }}</span>
                                        </div>
                                        <div class="text-end">
                                            <small class="fw-bold text-success resultado-conversao" style="display: none;">
                                                Conversão: <span>0</span> un/kg
                                            </small>
                                        </div>
                                        <input type="text" name="especificacao[]" class="form-control form-control-sm mt-1" placeholder="Ex: Marca X, Pacote 500g">
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
                <div class="modal-footer bg-light">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="submit" class="btn btn-warning fw-bold text-white px-4">Salvar Rascunho</button></div>
            </div>
        </form>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function () {
    // --- Lógica de Gráficos ---
    Chart.defaults.font.family = "'Inter', sans-serif";
    Chart.defaults.color = '#6c757d';

    new Chart(document.getElementById('topEscolasChart').getContext('2d'), {
        type: 'bar',
        data: {
            labels: {{ escolas_labels|tojson }},
            datasets: [{ label: 'Consumo', data: {{ escolas_data|tojson }}, backgroundColor: '#0d6efd', borderRadius: 5, barThickness: 20 }]
        },
        options: { indexAxis: 'y', responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { x: { grid: { display: false } }, y: { grid: { display: false } } } }
    });

    new Chart(document.getElementById('topProdutosChart').getContext('2d'), {
        type: 'doughnut',
        data: {
            labels: {{ produtos_labels|tojson }},
            datasets: [{ data: {{ produtos_data|tojson }}, backgroundColor: ['#0d6efd', '#6610f2', '#6f42c1', '#d63384', '#fd7e14'], hoverOffset: 10, borderWidth: 0 }]
        },
        options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'bottom', labels: { usePointStyle: true, padding: 20 } } }, cutout: '70%' }
    });

    // --- Lógica de Cálculo Dinâmico no Modal ---
    const inputsQtd = document.querySelectorAll('.input-qtd');

    inputsQtd.forEach(input => {
        input.addEventListener('input', function() {
            const fator = parseFloat(this.getAttribute('data-fator'));
            const qtd = parseFloat(this.value) || 0;
            const containerResultado = this.closest('td').querySelector('.resultado-conversao');
            const spanResultado = containerResultado.querySelector('span');

            if (qtd > 0 && fator > 1) {
                const total = (qtd * fator).toLocaleString('pt-BR', { minimumFractionDigits: 2 });
                spanResultado.textContent = total;
                containerResultado.style.display = 'block';
            } else {
                containerResultado.style.display = 'none';
            }
        });
    });
});
</script>
{% endblock %}