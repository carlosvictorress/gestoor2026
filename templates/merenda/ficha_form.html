{% extends 'base.html' %}
{% block content %}
<div class="container mt-4">
    <h2>Nova Ficha de Distribuição</h2>
    <form method="POST">
        <div class="mb-3">
            <label class="form-label">Escola</label>
            <select name="escola_id" class="form-select">
                {% for e in escolas %}
                <option value="{{ e.id }}">{{ e.nome }}</option>
                {% endfor %}
            </select>
        </div>
        <div class="mb-3">
            <label class="form-label">Mês de Referência</label>
            <input type="text" name="mes_referencia" class="form-control" placeholder="Ex: Março/2026">
        </div>
        <div class="mb-3">
            <label class="form-label">Tipo de Gênero</label>
            <select name="tipo_genero" class="form-select">
                <option value="PERECÍVEIS">PERECÍVEIS</option>
                <option value="NÃO PERECÍVEIS">NÃO PERECÍVEIS</option>
            </select>
        </div>

        <h4>Produtos</h4>
        <table class="table">
            <thead>
                <tr>
                    <th>Produto</th>
                    <th>Quantidade</th>
                </tr>
            </thead>
            <tbody>
    {% if editando %}
        {# MODO EDIÇÃO: Mostra apenas os produtos que já estão na ficha #}
        {% for item in ficha.itens %}
        <tr>
            <td>
                {{ item.produto.nome }}
                <input type="hidden" name="produto_id[]" value="{{ item.produto.id }}">
            </td>
            <td>
                <input type="number" name="quantidade[]" class="form-control" step="0.01" value="{{ item.quantidade }}">
            </td>
        </tr>
        {% endfor %}
    {% else %}
        {# MODO CRIAÇÃO: Mostra todos os produtos para preencher #}
        {% for p in produtos %}
        <tr>
            <td>{{ p.nome }}</td>
            <td>
                <input type="hidden" name="produto_id[]" value="{{ p.id }}">
                <input type="number" name="quantidade[]" class="form-control" step="0.01">
            </td>
        </tr>
        {% endfor %}
    {% endif %}
</tbody>
        </table>
        <button type="submit" class="btn btn-primary">Salvar Ficha</button>
    </form>
</div>
{% endblock %}