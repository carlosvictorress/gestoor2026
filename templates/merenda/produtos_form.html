{% extends 'base.html' %}

{% block title %}{{ 'Editar' if produto else 'Cadastrar' }} Produto{% endblock %}

{% block content %}
<div class="container-fluid px-4">
    <div class="d-flex justify-content-between align-items-center my-4">
        <div>
            <h2 class="fw-bold text-primary"><i class="bi bi-box-seam-fill"></i> {{ 'Editar' if produto else 'Novo' }} Produto</h2>
            <p class="text-muted">Gestão completa de itens da merenda escolar</p>
        </div>
        <a href="{{ url_for('merenda.listar_produtos') }}" class="btn btn-outline-secondary">
            <i class="bi bi-arrow-left"></i> Voltar
        </a>
    </div>

    <form method="POST">
        <div class="row">
            <div class="col-lg-8">
                
                <div class="card shadow-sm mb-4 border-top-primary">
    <div class="card-header bg-white py-3">
        <h5 class="m-0 fw-bold text-dark"><i class="bi bi-info-circle text-primary me-2"></i>Identificação do Produto</h5>
    </div>
    <div class="card-body">
        <div class="row g-3">
            <div class="col-md-12">
                <label for="nome" class="form-label fw-bold">Nome do Produto <span class="text-danger">*</span></label>
                <input type="text" class="form-control form-control-lg" name="nome" id="nome" value="{{ produto.nome if produto else '' }}" required placeholder="Ex: Arroz Agulhinha Tipo 1">
            </div>
            
            <div class="col-md-4">
                <label for="categoria" class="form-label">Categoria</label>
                <select class="form-select" name="categoria" id="categoria">
                    <option value="" disabled selected>Selecione...</option>
                    <option value="Cereais e Grãos" {{ 'selected' if produto and produto.categoria == 'Cereais e Grãos' }}>Cereais e Grãos</option>
                    <option value="Proteína Animal" {{ 'selected' if produto and produto.categoria == 'Proteína Animal' }}>Proteína Animal (Carnes/Ovos)</option>
                    <option value="Hortifrúti" {{ 'selected' if produto and produto.categoria == 'Hortifrúti' }}>Hortifrúti (Legumes/Frutas)</option>
                    <option value="Laticínios" {{ 'selected' if produto and produto.categoria == 'Laticínios' }}>Laticínios</option>
                    <option value="Padaria" {{ 'selected' if produto and produto.categoria == 'Padaria' }}>Padaria/Massas</option>
                    <option value="Temperos" {{ 'selected' if produto and produto.categoria == 'Temperos' }}>Temperos/Óleos</option>
                </select>
            </div>

            <div class="col-md-4">
                <label for="unidade_consumo" class="form-label fw-bold">Unidade de Estoque (Saída p/ Escola)*</label>
                <select class="form-select border-primary" name="unidade_consumo" id="unidade_consumo" required>
                    <option value="KG" {{ 'selected' if produto and (produto.unidade_consumo == 'KG' or produto.unidade_medida == 'KG') }}>Quilograma (KG)</option>
                    <option value="UNID" {{ 'selected' if produto and (produto.unidade_consumo == 'UNID' or produto.unidade_medida == 'UNID') }}>Unidade (UNID)</option>
                    <option value="L" {{ 'selected' if produto and (produto.unidade_consumo == 'L' or produto.unidade_medida == 'L') }}>Litro (L)</option>
                    <option value="PCT" {{ 'selected' if produto and (produto.unidade_consumo == 'PCT' or produto.unidade_medida == 'PCT') }}>Pacote (PCT)</option>
                </select>
                <div class="form-text">É como o produto será contado na prateleira.</div>
            </div>

            <div class="col-md-4">
                <label class="form-label fw-bold">Recebido em Fardo/Caixa?</label>
                <div class="form-check form-switch mt-2">
                    <input class="form-check-input" type="checkbox" id="tem_fardo" onchange="toggleFardo()">
                    <label class="form-check-label" for="tem_fardo">Sim, possui embalagem master</label>
                </div>
            </div>

            <div class="col-md-12 bg-light p-3 rounded border" id="secao_fardo" style="display: none;">
                <div class="row">
                    <div class="col-md-6">
                        <label for="unidade_medida" class="form-label fw-bold">Tipo de Embalagem Master</label>
                        <select class="form-select" name="unidade_medida" id="unidade_medida">
                            <option value="FRD" {{ 'selected' if produto and produto.unidade_medida == 'FRD' }}>Fardo (FRD)</option>
                            <option value="CX" {{ 'selected' if produto and produto.unidade_medida == 'CX' }}>Caixa (CX)</option>
                        </select>
                    </div>
                    <div class="col-md-6">
                        <label for="fator_conversao" class="form-label fw-bold">Qtd de unidades/kg dentro do Fardo/Caixa</label>
                        <input type="number" step="0.01" class="form-control" name="fator_conversao" id="fator_conversao" value="{{ produto.fator_conversao if produto else '1.0' }}">
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

            <div class="col-lg-4">
                <div class="card shadow-sm mb-4 border-top-warning">
                    <div class="card-header bg-white py-3">
                        <h5 class="m-0 fw-bold text-dark"><i class="bi bi-truck text-warning me-2"></i>Logística</h5>
                    </div>
                    <div class="card-body">
                        <div class="mb-3">
                            <label for="estoque_minimo" class="form-label fw-bold">Estoque Mínimo (Alerta)</label>
                            <div class="input-group">
                                <span class="input-group-text"><i class="bi bi-bell"></i></span>
                                <input type="number" step="0.01" class="form-control" name="estoque_minimo" id="estoque_minimo" value="{{ produto.estoque_minimo if produto else '10' }}" placeholder="Qtd mínima">
                            </div>
                            <div class="form-text">Alerta baseado na unidade de consumo.</div>
                        </div>

                        <div class="mb-3">
                            <label for="tipo_armazenamento" class="form-label fw-bold">Armazenamento</label>
                            <select class="form-select" name="tipo_armazenamento">
                                <option value="Seco/Temperatura Ambiente" {{ 'selected' if produto and produto.tipo_armazenamento == 'Seco/Temperatura Ambiente' }}>Seco (Ambiente)</option>
                                <option value="Refrigerado" {{ 'selected' if produto and produto.tipo_armazenamento == 'Refrigerado' }}>Refrigerado (Geladeira)</option>
                                <option value="Congelado" {{ 'selected' if produto and produto.tipo_armazenamento == 'Congelado' }}>Congelado (Freezer)</option>
                            </select>
                        </div>

                        <div class="form-check form-switch mb-3 p-3 bg-light rounded border">
                            <input class="form-check-input" type="checkbox" id="perecivel" name="perecivel" {{ 'checked' if not produto or produto.perecivel }}>
                            <label class="form-check-label fw-bold" for="perecivel">Produto Perecível?</label>
                        </div>
                        
                        <div class="alert alert-info d-flex align-items-center" role="alert">
                            <i class="bi bi-info-circle-fill me-2 fs-4"></i>
                            <div class="small">
                                Lembre-se: O <strong>Fator de Conversão</strong> pode ser editado aqui caso o novo lote recebido tenha peso diferente do anterior.
                            </div>
                        </div>
                    </div>
                </div>

                <div class="d-grid gap-2">
                    <button type="submit" class="btn btn-primary btn-lg"><i class="bi bi-save"></i> Salvar Dados</button>
                    <a href="{{ url_for('merenda.listar_produtos') }}" class="btn btn-light border">Cancelar</a>
                </div>
            </div>
        </div>
    </form>
</div>

<script>
function toggleFardo() {
    const check = document.getElementById('tem_fardo');
    const secao = document.getElementById('secao_fardo');
    const fatorInput = document.getElementById('fator_conversao');
    const unidCompra = document.getElementById('unidade_medida');

    if (check.checked) {
        secao.style.display = 'block';
    } else {
        secao.style.display = 'none';
        fatorInput.value = "1.0"; // Se não tem fardo, a entrada é 1 pra 1
        unidCompra.value = document.getElementById('unidade_consumo').value; 
    }
}

// Executa ao carregar para verificar se é edição de um produto que já é fardo
document.addEventListener('DOMContentLoaded', function() {
    const fator = parseFloat(document.getElementById('fator_conversao').value);
    if (fator > 1) {
        document.getElementById('tem_fardo').checked = true;
        toggleFardo();
    }
});
</script>

<style>
    .border-top-primary { border-top: 4px solid #0d6efd !important; }
    .border-top-success { border-top: 4px solid #198754 !important; }
    .border-top-warning { border-top: 4px solid #ffc107 !important; }
</style>
{% endblock %}