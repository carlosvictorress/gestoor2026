{% extends 'base.html' %}

{% block title %}Relatórios Técnicos e Ofícios{% endblock %}

{% block content %}
<h2><i class="bi bi-file-earmark-richtext"></i> Gestão de Relatórios Técnicos e Ofícios</h2>
<p class="text-muted">Área destinada à elaboração de documentos oficiais da Nutrição Escolar.</p>
<hr>

<!-- Formulário de Criação -->
<div class="card shadow-sm mb-5">
    <div class="card-header bg-light">
        <h5 class="mb-0"><i class="bi bi-pen"></i> Redigir Novo Documento</h5>
    </div>
    <div class="card-body">
        <form method="POST" enctype="multipart/form-data">
            <!-- Cabeçalho do Documento -->
            <div class="row g-3 mb-3">
                <div class="col-md-3">
                    <label for="tipo_documento" class="form-label">Tipo de Documento*</label>
                    <select class="form-select" name="tipo_documento" id="tipo_documento" required>
                        <option value="Relatório Técnico">Relatório Técnico</option>
                        <option value="Parecer Técnico">Parecer Técnico</option>
                        <option value="Ofício">Ofício</option>
                        <option value="Memorando">Memorando</option>
                        <option value="Notificação">Notificação de Irregularidade</option>
                    </select>
                </div>
                <div class="col-md-3">
                    <label for="numero_documento" class="form-label">Nº / Ano*</label>
                    <input type="text" class="form-control" name="numero_documento" id="numero_documento" placeholder="Ex: 001/2024" required>
                </div>
                <div class="col-md-3">
                    <label for="data_emissao" class="form-label">Data de Emissão*</label>
                    <input type="date" class="form-control" name="data_emissao" id="data_emissao" value="{{ data_hoje }}" required>
                </div>
                <div class="col-md-3">
                    <label for="local_emissao" class="form-label">Local*</label>
                    <input type="text" class="form-control" name="local_emissao" id="local_emissao" value="Prefeitura Municipal" required>
                </div>
            </div>

            <!-- Destinatário -->
            <div class="row g-3 mb-3">
                <div class="col-md-2">
                    <label for="vocativo" class="form-label">Vocativo</label>
                    <select class="form-select" name="vocativo" id="vocativo">
                        <option value="Ilmo(a). Sr(a).">Ilmo(a). Sr(a).</option>
                        <option value="Exmo(a). Sr(a).">Exmo(a). Sr(a).</option>
                        <option value="Ao(A) Senhor(a)">Ao(A) Senhor(a)</option>
                        <option value="Aos Diretores">Aos Diretores</option>
                    </select>
                </div>
                <div class="col-md-5">
                    <label for="destinatario_nome" class="form-label">Nome do Destinatário*</label>
                    <input type="text" class="form-control" name="destinatario_nome" id="destinatario_nome" placeholder="Ex: João da Silva" required>
                </div>
                <div class="col-md-5">
                    <label for="destinatario_cargo" class="form-label">Cargo / Setor</label>
                    <input type="text" class="form-control" name="destinatario_cargo" id="destinatario_cargo" placeholder="Ex: Secretário de Educação">
                </div>
            </div>

            <!-- Assunto e Corpo -->
            <div class="mb-3">
                <label for="assunto" class="form-label">Assunto*</label>
                <input type="text" class="form-control" name="assunto" id="assunto" placeholder="Resumo do conteúdo (Ex: Vistoria na Escola X)" required>
            </div>

            <div class="mb-3">
                <label for="corpo_texto" class="form-label">Corpo do Texto*</label>
                <textarea class="form-control" name="corpo_texto" id="corpo_texto" rows="10" placeholder="Digite aqui o conteúdo técnico do relatório ou ofício..." required></textarea>
                <div class="form-text">Seja claro e objetivo. Para relatórios de visita, descreva as condições encontradas e as recomendações.</div>
            </div>

            <!-- Anexos -->
            <div class="mb-3">
                <label for="anexos" class="form-label">Anexos (Fotos, Laudos, etc.)</label>
                <input class="form-control" type="file" id="anexos" name="anexos" multiple>
                <div class="form-text">Selecione um ou mais arquivos para anexar ao relatório.</div>
            </div>

            <!-- Fecho e Assinatura -->
            <div class="row g-3 mb-3">
                <div class="col-md-4">
                    <label for="fecho" class="form-label">Fecho</label>
                    <select class="form-select" name="fecho" id="fecho">
                        <option value="Atenciosamente,">Atenciosamente,</option>
                        <option value="Respeitosamente,">Respeitosamente,</option>
                        <option value="Nestes termos, pede deferimento.">Nestes termos, pede deferimento.</option>
                    </select>
                </div>
                <div class="col-md-8">
                    <label for="responsavel_assinatura" class="form-label">Responsável pela Assinatura*</label>
                    <input type="text" class="form-control" name="responsavel_assinatura" id="responsavel_assinatura" value="{{ current_user.nome if current_user else '' }}" placeholder="Nome do Nutricionista / Servidor" required>
                </div>
            </div>

            <div class="text-end">
                <button type="reset" class="btn btn-secondary">Limpar</button>
                <button type="submit" class="btn btn-primary"><i class="bi bi-save"></i> Salvar Documento</button>
            </div>
        </form>
    </div>
</div>

<!-- Lista de Relatórios Salvos -->
<div class="card shadow-sm">
    <div class="card-header">
        <h5 class="mb-0"><i class="bi bi-archive"></i> Histórico de Documentos Emitidos</h5>
    </div>
    <div class="card-body">
        <div class="table-responsive">
            <table class="table table-hover table-striped align-middle">
                <thead class="table-light">
                    <tr>
                        <th>Data</th>
                        <th>Nº Documento</th>
                        <th>Tipo</th>
                        <th>Assunto</th>
                        <th>Destinatário</th>
                        <th class="text-center">Ações</th>
                    </tr>
                </thead>
                <tbody>
                    {% for doc in documentos %}
                    <tr>
                        <td>{{ doc.data_emissao.strftime('%d/%m/%Y') }}</td>
                        <td class="fw-bold">{{ doc.numero_documento }}</td>
                        <td><span class="badge bg-info text-dark">{{ doc.tipo_documento }}</span></td>
                        <td>
                            {{ doc.assunto }}
                            {% if doc.anexos %}
                            <span class="badge bg-light text-secondary border ms-1" title="{{ doc.anexos|length }} arquivo(s) anexado(s)"><i class="bi bi-paperclip"></i> {{ doc.anexos|length }}</span>
                            {% endif %}
                        </td>
                        <td>{{ doc.destinatario_nome }}</td>
                        <td class="text-center">
                            <button type="button" class="btn btn-sm btn-outline-primary" data-bs-toggle="modal" data-bs-target="#modalVisualizar{{ doc.id }}" title="Visualizar"><i class="bi bi-eye"></i></button>
                            <a href="{{ url_for('merenda.imprimir_relatorio', id=doc.id) }}" target="_blank" class="btn btn-sm btn-danger" title="Imprimir Oficial"><i class="bi bi-printer-fill"></i> PDF</a>
                        </td>
                    </tr>

                    <!-- Modal de Visualização -->
                    <div class="modal fade" id="modalVisualizar{{ doc.id }}" tabindex="-1" aria-hidden="true">
                        <div class="modal-dialog modal-lg">
                            <div class="modal-content">
                                <div class="modal-header bg-light">
                                    <h5 class="modal-title"><i class="bi bi-file-text"></i> Detalhes do Documento</h5>
                                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                                </div>
                                <div class="modal-body text-start">
                                    <div class="row mb-3">
                                        <div class="col-md-6">
                                            <strong>Tipo:</strong> {{ doc.tipo_documento }}<br>
                                            <strong>Número:</strong> {{ doc.numero_documento }}<br>
                                            <strong>Data:</strong> {{ doc.data_emissao.strftime('%d/%m/%Y') }}
                                        </div>
                                        <div class="col-md-6">
                                            <strong>Destinatário:</strong> {{ doc.destinatario_nome }}<br>
                                            <strong>Cargo:</strong> {{ doc.destinatario_cargo or '-' }}
                                        </div>
                                    </div>
                                    
                                    <div class="mb-3">
                                        <strong>Assunto:</strong> {{ doc.assunto }}
                                    </div>
                                    
                                    <div class="p-3 bg-light border rounded mb-3" style="max-height: 300px; overflow-y: auto; white-space: pre-wrap;">{{ doc.corpo_texto }}</div>
                                    
                                    {% if doc.anexos %}
                                    <h6 class="border-bottom pb-2 mb-2">Anexos</h6>
                                    <div class="list-group">
                                        {% for anexo in doc.anexos %}
                                        <a href="{{ url_for('merenda.download_anexo', anexo_id=anexo.id) }}" target="_blank" class="list-group-item list-group-item-action d-flex justify-content-between align-items-center">
                                            <div>
                                                <i class="bi bi-paperclip"></i> {{ anexo.nome_original }}
                                                <small class="text-muted d-block">{{ anexo.descricao or '' }}</small>
                                            </div>
                                            <span class="badge bg-secondary rounded-pill"><i class="bi bi-download"></i> Baixar</span>
                                        </a>
                                        {% endfor %}
                                    </div>
                                    {% endif %}
                                </div>
                                <div class="modal-footer">
                                    <a href="{{ url_for('merenda.imprimir_relatorio', id=doc.id) }}" target="_blank" class="btn btn-danger"><i class="bi bi-printer"></i> Gerar PDF Oficial</a>
                                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fechar</button>
                                </div>
                            </div>
                        </div>
                    </div>
                    {% else %}
                    <tr>
                        <td colspan="6" class="text-center text-muted py-4">Nenhum documento registrado até o momento.</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>
{% endblock %}