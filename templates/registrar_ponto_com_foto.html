{% extends 'base.html' %}

{% block extra_head %}
{{ super() }}
<script src="https://cdn.tailwindcss.com"></script>
<style>
    /* Estilo para spinner e ocultar elementos em Tailwind */
    .hidden { display: none !important; }
    .animate-spin {
        animation: spin 1s linear infinite;
    }
    @keyframes spin {
        from { transform: rotate(0deg); }
        to { transform: rotate(360deg); }
    }
    /* Estilo para corrigir o espelhamento da câmera no canvas */
    #videoElement {
        transform: scaleX(-1);
    }
</style>
{% endblock %}


{% block title %}Registrar Ponto{% endblock %}

{% block content %}
<div class="min-h-screen flex items-center justify-center bg-gray-100 p-4">
    <div class="bg-white p-8 rounded-lg shadow-xl w-full max-w-md">
        <h2 class="text-3xl font-bold text-center text-gray-800 mb-6">
            <i class="bi bi-fingerprint mr-2"></i> Registrar Ponto
        </h2>

        {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages %}
                <div class="mb-4">
                    {% for category, message in messages %}
                        <div class="alert alert-{{ category }} alert-dismissible fade show" role="alert">
                            {{ message }}
                            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                        </div>
                    {% endfor %}
                </div>
            {% endif %}
        {% endwith %}

        <form method="POST" id="pontoForm">
            <div class="relative w-full aspect-video bg-gray-200 rounded-lg overflow-hidden mb-4 border-2 border-gray-300">
                <video id="videoElement" class="absolute inset-0 w-full h-full object-cover transform scale-x-[-1]" autoplay playsinline></video>
                <canvas id="canvasElement" class="absolute inset-0 w-full h-full object-cover hidden"></canvas>
                <div id="cameraStatus" class="absolute inset-0 flex items-center justify-center bg-black bg-opacity-70 text-white text-lg hidden">
                    Carregando Câmera...
                </div>
                <div id="countdownOverlay" class="absolute inset-0 flex items-center justify-center bg-black bg-opacity-70 text-white text-6xl font-bold hidden">
                    3
                </div>
            </div>

            <div class="mb-4">
                <label for="escola_id" class="block text-sm font-medium text-gray-700 mb-1">Selecione a Escola</label>
                <select id="escola_id" name="escola_id" required
                        class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm
                               {% if not escolas %} bg-red-50 border-red-400 text-red-700 placeholder-red-400 {% endif %}">
                    {% if not escolas %}
                        <option value="">-- Nenhuma escola ativa com localização cadastrada --</option>
                    {% else %}
                        <option value="">-- Onde você está? --</option>
                        {% for escola in escolas %}
                            <option value="{{ escola.id }}">{{ escola.nome }}</option>
                        {% endfor %}
                    {% endif %}
                </select>
            </div>

            <div class="mb-6">
                <label for="cpf" class="block text-sm font-medium text-gray-700 mb-1">CPF do Servidor</label>
                <input type="text" id="cpf" name="cpf" required placeholder="000.000.000-00"
                       class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
            </div>

            <input type="hidden" id="latitude" name="latitude">
            <input type="hidden" id="longitude" name="longitude">
            <input type="hidden" id="foto" name="foto"> {# Base64 da imagem #}
            <input type="hidden" id="tipo" name="tipo"> {# entrada ou saida #}

            <div class="space-y-4">
                <button type="button" id="btnRegistrarEntrada"
                        class="w-full flex justify-center py-3 px-4 border border-transparent rounded-md shadow-sm text-lg font-medium text-white bg-green-600 hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500 transition ease-in-out duration-150">
                    <i class="bi bi-box-arrow-in-right mr-2"></i> Registrar Entrada
                </button>

                <button type="button" id="btnRegistrarSaida"
                        class="w-full flex justify-center py-3 px-4 border border-transparent rounded-md shadow-sm text-lg font-medium text-white bg-red-600 hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500 transition ease-in-out duration-150">
                    <i class="bi bi-box-arrow-left mr-2"></i> Registrar Saída
                </button>
            </div>
            
            <div id="loadingOverlay" class="fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center z-50 hidden">
                <div class="text-white text-center">
                    <div class="spinner-border animate-spin inline-block w-8 h-8 border-4 rounded-full" role="status">
                        <span class="visually-hidden">Carregando...</span>
                    </div>
                    <p class="mt-3 text-xl">Registrando ponto...</p>
                </div>
            </div>

        </form>
    </div>
</div>
{% endblock %}

{% block scripts %}
{{ super() }} 

<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery.mask/1.14.16/jquery.mask.min.js"></script>

<script>
    // Variáveis globais para a câmera e geolocalização
    let video = document.getElementById('videoElement');
    let canvas = document.getElementById('canvasElement');
    let context = canvas.getContext('2d');
    let currentStream; 
    let cameraActive = false; 

    // Função para iniciar a câmera (Mantida)
    async function startCamera() {
        try {
            document.getElementById('cameraStatus').classList.remove('hidden');
            const stream = await navigator.mediaDevices.getUserMedia({ video: true });
            video.srcObject = stream;
            currentStream = stream;
            video.onloadedmetadata = () => {
                canvas.width = video.videoWidth;
                canvas.height = video.videoHeight;
                video.play();
                cameraActive = true;
                document.getElementById('cameraStatus').classList.add('hidden');
            };
        } catch (err) {
            console.error("Erro ao acessar a câmera: ", err);
            document.getElementById('cameraStatus').textContent = "Erro: Câmera não disponível.";
            document.getElementById('cameraStatus').classList.remove('hidden');
            cameraActive = false;
        }
    }

    // --- FUNÇÃO CORRIGIDA: RETORNA UMA PROMISE PARA GARANTIR A ESPERA ---
    function getPositionPromise() {
        return new Promise((resolve) => {
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(
                    (position) => {
                        // SUCESSO
                        resolve({ lat: position.coords.latitude, lon: position.coords.longitude });
                    },
                    (error) => {
                        // ERRO ou NEGAÇÃO: Usa 'N/A' e avisa o usuário (o backend deve permitir 'N/A')
                        console.error("Erro de Geolocalização:", error.code);
                        if (error.code === 1) { // PERMISSION_DENIED
                            alert("Atenção: A permissão de geolocalização foi negada. O ponto será registrado sem coordenadas de GPS.");
                        } else {
                            alert("Atenção: Falha ao obter GPS. O ponto será registrado sem coordenadas.");
                        }
                        resolve({ lat: 'N/A', lon: 'N/A' }); 
                    },
                    { enableHighAccuracy: true, timeout: 7000, maximumAge: 0 } 
                );
            } else {
                // Navegador não suporta
                alert("Seu navegador não suporta geolocalização.");
                resolve({ lat: 'N/A', lon: 'N/A' });
            }
        });
    }

    // --- FUNÇÃO PRINCIPAL DE CAPTURA E SUBMISSÃO (AGORA ASYNC) ---
    async function capturarESubmeter(tipoPonto) {
        // Validações...
        const escolaId = document.getElementById('escola_id').value;
        const cpf = document.getElementById('cpf').value;
        if (!escolaId) { alert("Por favor, selecione uma escola."); return; }
        if (!cpf || cpf.replace(/\D/g, '').length !== 11) { alert("Por favor, insira um CPF válido."); return; }
        if (!cameraActive) { alert("A câmera não está ativa."); return; }

        // 1. Desabilita botões e mostra loading
        document.getElementById('btnRegistrarEntrada').disabled = true;
        document.getElementById('btnRegistrarSaida').disabled = true;
        document.getElementById('loadingOverlay').classList.remove('hidden');

        // 2. AGUARDA A CAPTURA DE LOCALIZAÇÃO (Promisse)
        const coords = await getPositionPromise();
        
        // 3. Preenche os campos hidden
        document.getElementById('latitude').value = coords.lat;
        document.getElementById('longitude').value = coords.lon;
        
        // 4. Inicia o countdown
        video.classList.add('hidden');
        document.getElementById('countdownOverlay').classList.remove('hidden');

        let count = 3;
        const countdownInterval = setInterval(() => {
            document.getElementById('countdownOverlay').textContent = count;
            count--;
            if (count < 0) {
                clearInterval(countdownInterval);
                document.getElementById('countdownOverlay').classList.add('hidden');
                
                // Captura a foto (com espelhamento)
                context.save();
                context.scale(-1, 1); 
                context.drawImage(video, -canvas.width, 0, canvas.width, canvas.height); 
                context.restore();
                
                const fotoDataUrl = canvas.toDataURL('image/jpeg', 0.8);

                // Preenche o resto e submete
                document.getElementById('foto').value = fotoDataUrl;
                document.getElementById('tipo').value = tipoPonto;
                document.getElementById('pontoForm').submit();
            }
        }, 1000); 
    }

    // Event listeners
    document.addEventListener('DOMContentLoaded', () => {
        startCamera();
        
        $('#cpf').mask('000.000.000-00'); 

        document.getElementById('btnRegistrarEntrada').addEventListener('click', () => {
            capturarESubmeter('entrada');
        });

        document.getElementById('btnRegistrarSaida').addEventListener('click', () => {
            capturarESubmeter('saida');
        });
    });

    window.addEventListener('beforeunload', stopCamera);
</script>
{% endblock %}